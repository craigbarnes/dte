#!/bin/sh

# This pre-commit hook creates a fresh, temporary checkout of the index
# (i.e. not including unstaged/dirty changes from the working tree)
# and then performs various checks, depending on what changed.

export POSIXLY_CORRECT=1
TMPDIR='.pre-commit-test'
PROGNAME="$0"

error() {
    echo "$PROGNAME:$1: Error: $2" >&2
    exit 1
}

changed_files() {
    git diff-index --cached --name-only --diff-filter=ACMR HEAD -- "$@"
}

git_ls() {
    git ls-files --error-unmatch "$@"
}

alias abort='error "${LINENO:-1}"'
set -u

for cmd in git gcc clang ccache awk pandoc mkdir cp basename diff; do
    if ! command -v "$cmd" >/dev/null; then
        abort "'$cmd' is required but couldn't be found"
    fi
done

test ! -e "$TMPDIR" || abort "path '$TMPDIR' already exists"

MAKE="$(command -v gmake || command -v make)"
test -x "$MAKE" || abort 'unable to find GNU Make command'
MAKE="$MAKE --no-print-directory -C $TMPDIR -j$(mk/nproc.sh)"

set -e
git checkout-index --prefix="$TMPDIR/" -a
trap "rm -rf '$TMPDIR'" EXIT HUP INT QUIT TERM

changed_base_makefiles=$(changed_files GNUmakefile mk/compat.mk mk/util.mk)
changed_doc_files=$(changed_files 'docs/dte*.md' mk/docs.mk)

if test "${changed_doc_files}${changed_base_makefiles}"; then
    # Snapshot and re-generate man pages, if any Markdown source file changed
    manpages=$(git_ls --format="$TMPDIR/%(path)" -- 'docs/dte*.[15]')
    mkdir -p "$TMPDIR/GEN/"
    cp $manpages "$TMPDIR/GEN/"
    $MAKE -B man

    # ...then check that the freshly generated files are identical to the
    # ones to be committed
    for file in $manpages; do
        base=$(basename "$file")
        orig="$TMPDIR/GEN/$base"
        echo "   CHECK  $orig"
        if ! diff "$file" "$orig" >/dev/null; then
            # shellcheck disable=SC2295
            abort "re-generate '${file##${TMPDIR}/}' before committing"
        fi
    done
fi

changed_indented_files=$(changed_files ':(attr:space-indent)')
changed_shell_files=$(changed_files ':(attr:shell)')
changed_c_files=$(changed_files '**.[ch]')
changed_build_mk=$(changed_files 'mk/build.mk')
changed_syntax_files=$(changed_files 'config/syntax/')

# Check for whitespace errors in changed files (if applicable)
if test "$changed_indented_files"; then
    tools/wscheck.awk $changed_indented_files
fi

# Run shellcheck(1) on changed shell scripts
if test "$changed_shell_files"; then
    shellcheck -fgcc $changed_shell_files
fi

if test "${changed_c_files}${changed_base_makefiles}${changed_build_mk}"; then
    # Check for header-related errors in changed C files
    tools/hdrcheck.awk $changed_c_files

    # Build and test with various configurations and compilers:
    export CFLAGS='-g -Og -pipe -Werror'
    export DEBUG=3
    for compiler in gcc clang; do
        export CC="ccache $compiler"
        $MAKE check
        $MAKE check ICONV_DISABLE=1
        $MAKE check DEBUG=0
    done
elif test "$changed_syntax_files"; then
    # If no C files or makefiles have changed but syntax files have, run
    # a single `make check` to ensure test_builtin_configs() passes
    $MAKE check CC='ccache gcc' CFLAGS='-g -Og -pipe -Werror' DEBUG=3
fi
