#!/bin/sh

# This pre-commit hook creates a fresh, temporary checkout of the index
# (i.e. not including unstaged/dirty changes from the working tree)
# and then performs a full build.

export POSIXLY_CORRECT=1
TMPDIR='.pre-commit-test'
PROGNAME="$0"

error() {
    echo "$PROGNAME:$1: Error: $2" >&2
    exit 1
}

changed_files() {
    git diff-index --cached --name-only --diff-filter=ACMR HEAD -- "$@"
}

generated_files() {
    git ls-files --error-unmatch ':(attr:is-generated)' "$@"
}

alias abort='error "${LINENO:-1}"'
set -u

for cmd in git gcc clang ccache awk pandoc mkdir cp basename diff; do
    if ! command -v "$cmd" >/dev/null; then
        abort "'$cmd' is required but couldn't be found"
    fi
done

test ! -e "$TMPDIR" || abort "path '$TMPDIR' already exists"

MAKE="$(command -v gmake || command -v make)"
test -x "$MAKE" || abort 'unable to find GNU Make command'
MAKE="$MAKE --no-print-directory -C $TMPDIR -j$(mk/nproc.sh)"

set -e
git checkout-index --prefix="$TMPDIR/" -a
trap "rm -rf '$TMPDIR'" EXIT HUP INT QUIT TERM

# Generated files that are checked into the repository have an "is-generated"
# attribute (set via .gitattributes):
generated=$(generated_files --format="$TMPDIR/%(path)")

# ...snapshot and re-generate these files:
mkdir -p "$TMPDIR/GEN/"
# shellcheck disable=SC2086
cp $generated "$TMPDIR/GEN/"
$MAKE -B man

# ...and then check the freshly generated files are identical to the
# ones that are to be committed:
for file in $generated; do
    base=$(basename "$file")
    orig="$TMPDIR/GEN/$base"
    echo "   CHECK  $orig"
    if ! diff "$file" "$orig" >/dev/null; then
        # shellcheck disable=SC2295
        abort "re-generate '${file##${TMPDIR}/}' before committing"
    fi
done

changed_indented_files=$(changed_files ':(attr:space-indent)')
changed_shell_files=$(changed_files ':(attr:shell)')
changed_c_files=$(changed_files '**.[ch]')

# Check for whitespace errors in changed files (if applicable)
if test "$changed_indented_files"; then
    # shellcheck disable=SC2086
    tools/wscheck.awk $changed_indented_files
fi

# Check for header-related errors in changed C files
if test "$changed_c_files"; then
    # shellcheck disable=SC2086
    tools/hdrcheck.awk $changed_c_files
fi

# Run shellcheck(1) on changed shell scripts
if test "$changed_shell_files"; then
    # shellcheck disable=SC2086
    shellcheck -fgcc $changed_shell_files
fi

# Build and test with various configurations and compilers:
export CFLAGS='-g -Og -pipe -Werror'
export DEBUG=3
for compiler in gcc clang; do
    export CC="ccache $compiler"
    $MAKE check
    $MAKE check ICONV_DISABLE=1
    $MAKE check DEBUG=0
done
